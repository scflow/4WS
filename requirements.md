# 4WS 二自由度车辆动力学仿真需求文档（v0.2，按论文模型修订）

> 本版在 v0.1 的基础上，按照你提供的论文中给出的二自由度四轮转向（4WS）车辆数学模型进行口径统一：符号、状态方程、理想横摆率、稳定性因数与后轮转角控制思路。

## 1. 目标与范围
- 建立与论文一致的 2DOF 4WS 自行车模型（横摆 r 与质心侧偏 β），纵向速度 U 为外部参数（可常值或缓变）。
- 支持四轮转向：前轮转角 δ_f、后轮转角 δ_r 可独立设定；含同相、反相与“理想横摆率跟踪”策略。
- 输出：β(t)、r(t)、a_y(t)、各轴侧向力 F_yf/F_yr、（可选）轨迹 x(t)、y(t)、ψ(t)；支持 CSV/PNG。

## 2. 符号与单位（与论文一致）
- 车辆参数：m（质量，kg）、I_z（横摆转动惯量，kg·m²）、a（质心到前轴距离，m）、b（质心到后轴距离，m）、L=a+b（轴距，m）。
- 轮胎侧偏刚度（轴级聚合）：k_f（前轴，N/rad）、k_r（后轴，N/rad）。注：论文中用 k_f、k_r 表示线性侧偏刚度，等价于我们之前的 C_f、C_r。
- 运动与输入：U（纵向速度，m/s）、β（侧偏角，rad）、r（横摆角速度，rad/s）、δ_f（前轮转角，rad）、δ_r（后轮转角，rad）。
- 单位：SI（m、kg、s、rad、N）。

## 3. 论文模型的基本方程
- 侧偏角与轮胎力（线性轮胎）：
  - α_f = β + a·r/U − δ_f
  - α_r = β − b·r/U − δ_r
  - F_yf = −k_f·α_f，F_yr = −k_r·α_r
- 质心侧向力与横摆力矩平衡：
  - m·U·(β̇ + r) = F_yf + F_yr
  - I_z·ṙ = a·F_yf − b·F_yr
- 展开后的状态方程（二维状态 X=[β, r]^T）：
  - β̇ = −[(k_f + k_r)/(mU)]·β + [−(a·k_f − b·k_r)/(mU²) − 1]·r + [(k_f·δ_f + k_r·δ_r)/(mU)]
  - ṙ = −[(a·k_f − b·k_r)/I_z]·β − [(a²·k_f + b²·k_r)/(I_z·U)]·r + [(a·k_f·δ_f − b·k_r·δ_r)/I_z]

## 4. 状态空间表示
- 令状态 X = [β, r]^T，输入向量 U_in = [δ_f, δ_r]^T，输出 Y 可选为 [β, r]^T 或附加 a_y、轨迹等。
- 矩阵形式：Ẋ = A·X + B·U_in；Y = C·X + D·U_in，其中
  - A = [[ −(k_f + k_r)/(mU),  −(a·k_f − b·k_r)/(mU²) − 1 ],
         [ −(a·k_f − b·k_r)/I_z,  −(a²·k_f + b²·k_r)/(I_z·U) ]]
  - B = [[ k_f/(mU),  k_r/(mU) ],
         [ a·k_f/I_z,  −b·k_r/I_z ]]
  - C、D 视输出选择而定，默认 C=I₂，D=0。
- 横向加速度（观测量）：a_y = U·(r + β̇)。

## 5. 稳定性因数与理想横摆率（论文口径）
- 稳定性因数（Understeer Gradient）记为 K，按照论文口径由车辆与轮胎参数给出；在前轮转向（δ_r=0）条件下，稳态横摆率增益可写为：
  - r_ref(U, δ_f) = [ U / ( L + K·U² ) ] · δ_f
  - 其中 L=a+b。K 的具体表达与 k_f、k_r、a、b、m 的组合有关（常见写法：K = (m/L)·(b/k_r − a/k_f)，本项目将以此为默认口径，允许通过配置覆盖）。
- 饱和与安全约束（论文提出的限制思想）：
  - 采用摩擦极限约束 yaw rate：|r_ref| ≤ r_max = μ·g / U（μ 为附着系数，g 为重力加速度）。
  - 实现为 r_cmd = sat( r_ref, −μg/U, +μg/U )，并随 δ_f 符号保持一致。

## 6. 后轮转角控制方法（与论文一致的思路）
- 比例律（速度相关同/反相）：δ_r = K_ratio(U) · δ_f
  - 低速反相（机动性）：K_ratio(U) < 0
  - 高速同相（稳定性）：K_ratio(U) > 0
  - U ∈ [U₁, U₂] 区间进行平滑插值过渡。
- 理想横摆率跟踪（前馈+反馈）：
  - 目标：使 r → r_cmd（见第 5 节）。
  - 前馈：从 ṙ 方程中构造 δ_r_ff，使稳态 r ≈ r_cmd；简化稳态近似（β̇≈0, ṙ≈0）下：
    - 设 r=r_cmd、β 近似为小角（或用模型稳态解），得到
      δ_r_ff ≈ [ a·k_f·δ_f − (a·k_f − b·k_r)·β − (a²·k_f + b²·k_r)·r/U ] / ( b·k_r )
  - 反馈：δ_r = δ_r_ff + K_r·(r_cmd − r) + K_β·(β_ref − β)，其中 β_ref 可选 0 或根据模型稳态计算。
- 可扩展：支持使用 LQR/PID 在上述线性模型上直接设计 δ_r 控制律。

## 7. 输入工况与仿真
- δ_f(t)：阶跃、正弦/扫频、双移线、文件采样。
- U(t)：常速、分档、缓变；用于检验比例律由反相向同相的切换行为。
- 积分器：显式 RK4（默认），可选欧拉；建议 dt=1–5 ms。U→0 附近采用 U_min 与限幅保护，避免 r/U 奇异。

## 8. 输出与观测
- 状态：β(t), r(t)；响应：a_y(t), F_yf(t), F_yr(t)。
- 指标：横摆率增益 r/δ_f、峰值/整定时间；扫频下幅值与相位；轨迹（x,y,ψ）。
- 导出：CSV（数据）、PNG（图表）。

## 9. 参数配置
- 默认示例（可编辑）：
  - m=1500 kg，I_z=2500 kg·m²，a=1.2 m，b=1.6 m，L=2.8 m
  - k_f=1.6e5 N/rad，k_r=1.7e5 N/rad
  - μ=0.85（沥青干地），U=20 m/s
- 配置映射：支持以 JSON 指定 {m, I_z, a, b, k_f, k_r, μ, U, 策略参数}。

## 10. 软件设计与目录
- Python 3.10+；依赖 numpy、matplotlib。
- 模块：
  - params：车辆/仿真参数结构体（含 K 计算与单位校验）
  - tire：线性轮胎模型（k_f/k_r）
  - model：论文 2DOF 4WS 状态方程（A/B/C/D 与 a_y）
  - strategy：比例律、理想横摆率跟踪（前馈+反馈），限幅与平滑切换
  - scenarios：阶跃/扫频/双移线输入生成
  - sim：积分器与驱动；结果缓存与导出
  - viz：时域曲线、频域、轨迹绘图
  - io：JSON/CSV 读写
- 目录草案：src/*.py，examples/*.py，tests/*.py，requirements.txt，README.md。

## 11. 验收标准
- 方程一致性：当 δ_r=0 时，模型与经典 2DOF 前轮转向结果一致（同参数）。
- 理想横摆率：r_ref 与 K、U 的关系符合论文；r_cmd 受 μg/U 约束。
- 策略验证：比例律在低速反相/高速同相切换；跟踪策略可将 r 逼近 r_cmd。
- 数值稳定性：dt 变小结果收敛；RK4 与欧拉趋势一致。
- 测试：A/B 构造、a_y 计算、K 计算、限幅保护、场景生成均有单元测试。

## 12. 风险与边界
- 线性轮胎在大侧偏角、高 a_y 下误差增大；输入限幅与 μg/U 约束必选。
- U→0 奇异需要保护；β 的稳态近似影响 δ_r_ff 精度，需反馈项补偿。
- 未考虑滚转、载荷迁移、非线性饱和与速度纵向动力学耦合。

## 13. 里程碑
- M1：项目骨架、参数模块与 K 计算；
- M2：模型/求解器与阶跃场景；
- M3：策略（比例律与跟踪）、限幅与插值；
- M4：可视化与导出；
- M5：测试与报告。

## 14. 变更记录
- v0.2：按论文统一符号与模型；新增状态空间矩阵、K 与 r_ref 口径、理想横摆率跟踪控制思路及饱和约束。