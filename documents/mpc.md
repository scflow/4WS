# 4-DOF 轨迹跟踪 MPC 推导与实现说明

本文档阐述项目中 `src/mpc.py` 的 4-DOF 轨迹跟踪模型预测控制（MPC）推导思路与计算流程，对应函数 `solve_mpc_kin_dyn_4dof` 的数学结构、离散化与二次规划（QP）组装方法。

## 问题定义与符号

- 增广状态向量：`x = [e_y, e_psi, beta, r]^T`
  - `e_y`：横向位置误差（左法线为正），相对于参考曲线局部切线法向定义
  - `e_psi`：航向误差（参考航向 − 当前航向），范围规约到 `(-π, π]`
  - `beta`：质心侧偏角
  - `r`：横摆角速度
- 控制输入：`u = [df, dr]^T`
  - `df`：前轮转角（rad）
  - `dr`：后轮转角（rad）
- 参考量：`r_ref` 为参考横摆率（由参考曲线曲率 `κ` 与车速 `U` 给出，`r_ref = U * κ`），随预测步 k 形成序列 `r_ref_seq[k]`。
- 采样周期：`dt`
- 预测时域长度：`H`

## 连续时间 4-DOF 误差-动力学模型

将运动学误差与 2DOF 动力学串联形成增广模型（实现见 `get_kin_dyn_4dof_derivatives`）：

1) 运动学误差近似（几何层）

- `e_y_dot ≈ U * (beta - e_psi)`：在小角假设下，横向误差随侧偏与航向误差耦合变化
- `e_psi_dot = -r + r_ref`：航向误差的变化由实际横摆率与目标横摆率差决定

2) 动力学（2DOF 侧向模型）

- 状态 `x_dyn = [beta, r]^T`
- 导数 `xdot_dyn = [beta_dot, r_dot]^T` 来自 2DOF 模型（`twodof.derivatives`），包含轮胎力模型（线性或 Pacejka）与车辆参数

据此得到连续时间增广导数：

```
x_dot_aug = [ e_y_dot,
              e_psi_dot,
              beta_dot,
              r_dot ]^T
```

## 数值线性化与离散化

为便于构造线性二次型优化，采用在 `k=0` 处数值线性化、并按欧拉法离散化（实现见 `linearize_kin_dyn_4dof`）：

- 在工作点 `(x0, u0)`（取当前误差与当前轮角）周围，对状态与输入分别使用微扰法求偏导：
  - `A = ∂x_dot/∂x |_(x0,u0)`，`B = ∂x_dot/∂u |_(x0,u0)`
- 离散化（前向欧拉）：
  - `A_d = I + A * dt`
  - `B_d = B * dt`

在线性时不变（LTI）近似下，预测状态满足：

```
x_{k+1} = A_d x_k + B_d u_k
```

## 输入如何作用到状态并在 MPC 中起作用

本节明确阐述控制输入 `u = [df, dr]^T` 如何影响增广状态 `x = [e_y, e_psi, beta, r]^T`，以及这种作用如何在 MPC 的预测与代价中体现。

### 作用路径（连续时间）

1) 动力学层（2DOF）：

- 轮胎侧偏角（小角近似下的典型形式）：
  - `alpha_f ≈ beta + (a/U) * r - df`
  - `alpha_r ≈ beta - (b/U) * r - dr`
- 侧向力（线性模型示意）：
  - `Fy_f ≈ -kf * alpha_f`
  - `Fy_r ≈ -kr * alpha_r`
- 车辆方程（2DOF）：
  - `m * U * (beta_dot + r) = Fy_f + Fy_r`
  - `Iz * r_dot = a * Fy_f - b * Fy_r`

由此可见：

- 增大 `df`（同向前轮转角）通常会减小 `alpha_f`，影响 `Fy_f`，进而作用于 `beta_dot` 与 `r_dot`；
- 增大 `dr`（同向后轮转角）改变后轴侧偏与力矩分配，对 `beta_dot` 与 `r_dot`的符号和幅值也产生显著影响（高速下后轮同向可增强转向响应，低速反向有利缩小转弯半径）。

2) 误差几何层：

- `e_y_dot = U * (beta - e_psi)`：输入通过改变 `beta` 与（见下一条）`e_psi` 间接影响横向误差演化；
- `e_psi_dot = -r + r_ref`：输入通过动态改变 `r`，从而影响航向误差的收敛到目标 `r_ref`。

整体连锁：`u → (alpha_f, alpha_r) → (Fy_f, Fy_r) → (beta_dot, r_dot) → (e_y_dot, e_psi_dot)`。

### 在线性化后的离散模型中的体现

在工作点 `(x0, u0)` 线性化并离散化后：

```
x_{k+1} = A_d x_k + B_d u_k
```

其中 `B_d = (∂x_dot/∂u)|_(x0,u0) * dt`。`B_d` 的两列分别刻画了 `df` 与 `dr` 对四个状态分量的边际影响：

- 第 1 列（对 `df` 的灵敏度）：`[∂e_y/∂df, ∂e_psi/∂df, ∂beta/∂df, ∂r/∂df]^T`
- 第 2 列（对 `dr` 的灵敏度）：`[∂e_y/∂dr, ∂e_psi/∂dr, ∂beta/∂dr, ∂r/∂dr]^T`

在堆叠预测矩阵中，控制序列按块乘至状态序列：

```
X = Φ x_0 + T U
```

`T` 的每个块 `A_d^{k-1-j} B_d` 显示了“第 j 步的控制输入”经由系统传播后对“第 k 步状态”的影响。因此，`U` 的作用通过 `T` 线性地进入 `X`。

### 在代价函数中的体现

代价函数对 `X` 与 `U` 的加权如下：

```
J(U) = (X - Xref)^T Qh (X - Xref) + U^T Rh U + (D U - g)^T R_Δ (D U - g)
```

- `Qh` 作用于误差状态：输入通过 `T` 改变 `X`，从而影响 `(X - Xref)` 的大小；这会直接驱动 `e_y/e_psi` 向 0 收敛、`r` 向 `r_ref` 跟随。
- `Rh` 约束输入幅值：抑制过大的 `df/dr`；
- `R_Δ` 约束输入变化率：`D U` 为差分矩阵定义的 `Δu`，抑制命令抖动与过快变化；`g` 注入上一时刻控制以定义首步差分。

若引入终端奖惩（可选增强），则在 `Q_{H-1}` 或额外软约束中加重末步的 `[e_y, e_psi]`，使 `U` 更强地驱动末端收敛到终点位置与航向角。

## 参考序列与曲率估计

- 参考轨迹 `plan = {(t,x,y,psi)}` 已给出坐标与航向；为兼容可能缺失的 `psi`，用相邻点差分近似切线航向。
- 取每步参考曲率 `κ_ref[k] ≈ Δψ/Δs`，得到 `r_ref_seq[k] = U * κ_ref[k]`。

## 预测矩阵构造（堆叠形式）

将 H 步预测堆叠为大矩阵，便于写成标准 QP：

- 状态堆叠：`X = [x_1; x_2; ...; x_H] ∈ R^{H*nx}`
- 控制堆叠：`U = [u_0; u_1; ...; u_{H-1}] ∈ R^{H*nu}`

递推可写为：

```
X = Φ x_0 + T U
```

其中：

- `Φ[k] = A_d^{k}`（第 k 步对初始状态的映射，k 从 1 到 H）
- `T[k,j] = A_d^{k-1-j} B_d`（k≥j+1 有效，否则为 0），实现见代码中对 `Tm` 的分块填充

## 成本函数与参考状态

目标是使误差收敛与横摆率跟随参考：

- 每步状态代价（对角权重）：`Q_k = diag(Q_ey, Q_epsi, Q_beta, Q_r)`
- 每步控制代价：`R_k = diag(R_df, R_dr)`
- 控制变化率惩罚：`R_Δ` 作用在 `Δu_k = u_k - u_{k-1}` 上（通过差分矩阵 `D` 实现）
- 参考状态：
  - `e_y_ref = 0`，`e_psi_ref = 0`，`beta_ref = 0`，`r_ref = r_ref_seq[k]`
- 堆叠得到：
  - `Qh = blockdiag(Q_0, ..., Q_{H-1})`
  - `Rh = blockdiag(R_0, ..., R_{H-1})`
  - `Xref = [x_ref(1); ...; x_ref(H)]`

代价函数（忽略常数项）：

```
J(U) = (X - Xref)^T Qh (X - Xref) + U^T Rh U + (D U - g)^T R_Δ (D U - g)
```

其中 `g` 注入了上一时刻控制 `u_prev`，保证首步变化率定义正确。

## QP 形式与求解

将 `X = Φ x0 + T U` 代入，得到标准二次型：

```
H U = -f
```

其中：

- `H = T^T Qh T + Rh + D^T R_Δ D`
- `f = (Φ x0 - Xref)^T Qh T - g^T R_Δ D`（再转置成列向量）

数值求解：

- 若 `H` 非奇异，直接解 `U = - H^{-1} f`
- 退化时用伪逆 `U = - H^+ f`

控制输出：

- 取首步 `u_0 = [df_cmd, dr_cmd]` 作为当前时刻的控制命令
- 可选地做限幅：`df_cmd, dr_cmd ∈ [-delta_max, +delta_max]`

## 总结

该 MPC 将几何层误差与 2DOF 动力学耦合为 4 维增广状态，采用一次线性化的 LTI 近似与堆叠预测矩阵，将跟踪问题转化为二次规划，首步控制用于当前执行。通过调节 `Q/R/R_Δ` 与（可选）终端权重/软约束，可以在“平滑控制”与“快速贴合终点”之间取得可控折中。
