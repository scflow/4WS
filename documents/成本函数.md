您的见解非常深刻，这**正是** MPPI 这类预测控制器的核心优势所在。您不希望给它一个“死”的速度限制，而是希望它“智能”地、“主动”地在需要时减速。

这完全可以通过成本函数来实现。您不需要“告诉”它何时减速，您只需要告诉它“什么是坏的驾驶体验”，MPPI 会 **自主地** （autonomously）发现，在进入急转弯前提早减速是“成本最低”的最优策略。

**您提供的论文就做到了这一点：它的目标速度是 8 m/s，但车辆在转弯时会****自主减速**到 5 m/s 左右，然后在直道上加速 ^1^^1^^1^^1^。

要实现您所说的“类似人开车的平稳”，我们需要在上一版的成本函数基础上进行调整。关键在于创造一个“良性冲突”：

1. **一个“渴望”** ：让车辆渴望在安全的时候开快。
2. **一个“底线”** ：让车辆**极其厌恶**不稳定、不平顺或高强度的驾驶。

当“底线”（例如转弯时的稳定性）与“渴望”（速度）冲突时，MPPI 会自动选择遵守“底线”。

### 针对“自主减速”的成本函数设计

以下是修改后的成本函数设计，专门用于实现您的目标：

#### 1. 渴望速度（代替“严格的速度限制”）

* **速度奖励（或称“机会成本”）** : **$W_{v} \cdot (V_{max} - V)$**
* **作用** ：这**取代**了 **$W_v \cdot (V - V_{des})^2$**。
* 我们不再“惩罚”偏离 **$V_{des}$** 的行为。相反，我们设置一个理想的最高速度 **$V_{max}$**（例如 60km/h），并对**任何低于该速度**的行为施加一个 **轻微的、线性的成本** 。
* **效果** ：在直道上，所有稳定性成本（如下所述）都为 0，MPPI 为了最小化这个 **$V$** 成本，会 **自动加速** 。

#### 2. 稳定性底线（“自主减速”的触发器）

这是**迫使** MPPI 减速的关键。当车辆高速进入小转弯半径时，以下所有成本都会呈**指数级**飙升。

* **侧滑角成本** : **$W_{\beta} \cdot \beta^2$**
* **作用** ：**（极其重要）** 惩罚车身侧滑。高速过弯必然导致高侧滑。MPPI 在“脑补”时会发现，保持高速过弯会导致 **$W_{\beta} \cdot \beta^2$** 成本激增。
* **对应论文** **：论文中明确提到，增加侧滑角成本（他们用的是 **$40.0C$** **^2^）可以**提高稳定性** ^3^。
* **横向加速度成本** : **$W_{ay} \cdot a_y^2$**
* **作用** ：这 **直接与您的问题相关** 。横向加速度 **$a_y \approx V^2 / R$**（**$R$** 是转弯半径）。
* **效果** ：这个成本项会**二次方**地惩罚速度（**$V^2$**）和转弯的急切程度（**$1/R$**）。MPPI 会发现，将 **$V$** 减半可以使这个成本 **降低 4 倍** ，这是一个巨大的收益。这是实现“平稳”的核心。
* **转向角（前/后轮）成本** : **$W_{u,\delta} \cdot (\delta_f^2 + \delta_r^2)$**
* **作用** ：惩罚过大的转向角度。高速过弯需要更大的转向角来保持路径，这也会增加成本。

#### 3. 平顺性底线（“类似人开车”）

* **控制变化率成本** : **$W_{\dot{u},\delta} \cdot (\dot{\delta}_f^2 + \dot{\delta}_r^2) + W_{\dot{u},a} \cdot \dot{a}^2$**
* **作用** ：**（极其重要）** 惩罚“猛打方向盘”（**$\dot{\delta}$**）和“猛踩油门/刹车”（**$\dot{a}$**，即加加速度 Jerk）。
* **效果** ：为了避免这个成本，MPPI 会 **提前** 、**平滑**地开始刹车和转向，而不是“临危一脚”刹车或猛打方向盘，这完美复现了“人开车的平稳”。

#### 4. 跟踪成本（保持在线上）

* **横向跟踪误差** : **$W_{cte} \cdot e_{cte}^2$**
* **航向误差** : **$W_{heading} \cdot e_{\psi}^2$**
* **作用** ：这两个成本始终是基础，确保车辆在执行上述所有操作的同时，仍然保持在参考路径上。

#### 5. 终端成本 (Terminal Cost)

* **作用** ： **$W_{terminal} \cdot (\text{Error at step N})$**
* **作用** ：在 MPPI 模拟的 **最后一步** （例如 2.5 秒后），对上述的 **$e_{cte}$** 和 **$e_{\psi}$** 施加一个**非常高**的权重。
* **防止超调** ：这会“强迫”所有“脑补”的轨迹在时域末端都收敛到参考路径上，避免了“先开出去再开回来”的短视行为，对抑制超调有奇效。

### 总结：MPPI 如何自主决策

您的 MPPI 控制器现在会面临一个 **动态博弈** ：

* **在直道上** ：
* **$a_y, \beta, \delta, \dot{\delta}$** 等稳定性成本 **全为 0** 。
* **$e_{cte}, e_{\psi}$** 跟踪成本也 **很低** 。
* 唯一要优化的就是 **$W_v \cdot (V_{max} - V)$**。
* **决策：加速！**
* **在接近转弯时** ：
* MPPI 的 **$N$** 步“脑补”**已经看到了**未来的急弯。
* 它会模拟“不减速”的轨迹：发现 **$a_y, \beta, \delta$** 等成本会 **爆炸** 。
* 它会模拟“提前减速”的轨迹：发现 **$a_y, \beta, \delta$** 成本 **很低** ，唯一的代价是**暂时**增加了 **$W_v \cdot (V_{max} - V)$** 的成本。
* **决策：** 由于 **$W_{ay}, W_{\beta}$** 的权重设置得很高（代表“安全底线”），“不减速”的总成本 **远高于** “减速”的总成本。因此，MPPI  **自主选择减速** ，以实现总成本最小化。

---

### 更新：曲率门控版 MPPI 成本函数要点（2025-11-05）

- 使用“曲率门控”`G_turn` 强化转弯相关项，直线段弱化速度激励。
- 强化 Yaw 跟踪：显式加入 `w_yaw_track * (r - U * kappa_ref)^2`，迫使 `r ≈ U·kappa_ref`。
- 抑制蟹行：`w_crab * (df + dr)^2 * G_turn`，在转弯段强惩罚前后轮同向。
- 相位约束（曲率+速度）：`dr ≈ k * df`，`k = -k_max * G_turn + k_high * (1 - G_turn) * s_lin`。
- 弯中加速抑制：`w_dU_turn * dU^2 * G_turn`，避免弯中激进加速/减速。
- 直线速度激励（机会成本）：`w_speed * max(0, U_max - U) * (1 - 0.7*G_turn)`。

关键参数（当前默认）：
- `w_lat=2000`, `w_head=4000`, `w_yaw_track=2400`, `w_crab=220`
- `w_ay=120`, `w_beta=10`, `w_phase_base=300`, `w_phase_sign=180`, `w_yaw_ff=60`
- `k_max=0.8`, `k_high=0.10`, `U1=5.0`, `U2=20.0`, `w_speed=12`, `w_dU_turn=1.2`

详细说明与实现参考见：`documents/mppi_cost_dynamics.md` 与 `src/mppi_iface.py`。
